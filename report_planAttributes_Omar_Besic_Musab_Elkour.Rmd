---
title: "Analysis of planAttributes.csv"
author: "Omar Besic und Musab Elkour" 
date: "23 Mai 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Wer?
Das **"Centers for Medicare & Medicaid Services (CMS) Center for Consumer Information & Insurance Oversight (CCIIO)** veröffentlicht sogenannte Exchange PUFs, um Transparenz und Zugang über Qualified Health Plans (QHPs) und Stand-alone Dental Plans (SADPs) zu schaffen. Diese werden Einzelpersonen und Kleinunternehmen über die Krankenversicherungsbörse angeboten.

***Wir behandeln in diesem Bericht das "Planattribute" - PUF***

Der Planattribute - PUF enthält unter Anderem Daten über maximale Selbstbehalte oder"Health Savings Accounts" der amerikanischen Bürger. Diese werden anonym auf Bundesebene geteilt und durch die jeweiligen Herausgeber der Versicherungen erfasst.

### Vorgehensweise 
1) Kontextanalyse der Daten
2) Kaggle Account erstellt + Daten extrahiert
3) Interessante Datensätze für die Auswertung herausgesucht
4) Gewählte Datensätze bereinigt
5) Bereinigte Datensätze manipuliert
5) Erstellen des Reports in RMarkdown

```{r,include=FALSE, echo=FALSE}
library(ggplot2)
library(readr)
library(dplyr) 
library(choroplethr)
library(extrafont)
library(extrafontdb)
library(RColorBrewer)
library(scales)
library(gridExtra)
library(choroplethrMaps)
library(knitr)
library(kableExtra)
library(RColorBrewer)
library(DT)
```

### Der Dataset - Ausschnitt des Headers
Insgesamt gibt es 179 Kolonnen. Untenstehend wird ein Ausschnitt der vorhandenen Kolonnen gezeigt. Die Rot markierten Zeilen (entspricht im planAttributes.csv den Spalten) werden in diesem Bericht eingehender analysiert.

```{r, echo=FALSE}
planAttributes <- read.csv("PlanAttributes.csv", stringsAsFactors = FALSE)

##Setwd for omar besic 
#setwd("C:/Users/omarb/Desktop/Studium/6. Semester/06_Business Intelligence im Spital/Projekt/bi_project")

##Setwd for musab elkour 
 setwd("C:/dev/bi_project")

planAttributesColumns <- as_tibble(planAttributes)
planAttributesColumns <- planAttributesColumns %>% select(110:130,150:165)


names(planAttributesColumns) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")
                , fixed_thead = list(enabled = T, background = "dark"))  %>%
  row_spec(cbind(12,31), bold = T, color = "white", background = "#D7261E")
```

# TEHBInnTier1FamilyMOOP
## EHB = Essential Health Benefits
## Moop = Maximum out of pocket

### Der maximale Selbstbehalt den man im Rahmen des Gesundheitsplans zahlen muss (für eine Familie). 

### Wir berechnen untenstehend

```{r,include=FALSE, echo=FALSE}
x <- knitr::kable(planAttributes[5,158:160], "html")
column_spec(x, 1:2, width = "20em", bold = TRUE, italic = TRUE)

# Maximum Out of Pocket for Medical and Drug EHB Benefits (Total),
# In Network (Tier 1), Family
# The max out of pocket is the amount of money that the family would 
# have to pay before the insurance covers everything 100%
# Give me the TEHBInnTier1FamilyMOOP column just for a short glimpse
planAttributes <- planAttributes %>% select(TEHBInnTier1FamilyMOOP)

# replace all "," with " " in TEHBInnTier1FamilyMOOP
# as example: given = $12,600 BUT wanted = $12600
planAttributes$TEHBInnTier1FamilyMOOP<- gsub(',', '', planAttributes$TEHBInnTier1FamilyMOOP)

# replace all "\\$" with " " in TEHBInnTier1FamilyMOOP
# as example: given = $12600 BUT wanted = 12600
planAttributes$TEHBInnTier1FamilyMOOP<- gsub('\\$', '', planAttributes$TEHBInnTier1FamilyMOOP)

# assign (and convert to numeric) the maximum out of pocket column to planAttributes$moop
planAttributes$moop<- as.numeric(planAttributes$TEHBInnTier1FamilyMOOP)

# fill the blank cells with 0
planAttributes$moop[is.na(planAttributes$moop)] <- 0

```


```{r, echo=FALSE}

# plot histogram of moop
ggplot(planAttributes, aes(x = planAttributes$moop)) + geom_histogram()


```




# SBCHavingDiabetesCoinsurance
## Analyse: Beträge der Deckungskosten der Mitversicherung für das Muster-SBC-Szenario von Diabetes

```{r,include=FALSE, echo=FALSE}
#import data with help of the readr package and reads comma delimited files
pa <- read.csv("PlanAttributes.csv", stringsAsFactors = FALSE)


#prints all the data in the columns which are in the business year 2014
#Just for checking the access to the data 
#subset and filter the data just for the buisness year 2014
pa <- subset(pa, BusinessYear == "2014")
print(subset(pa, BusinessYear == "2014"))


#A quick glimpse and then some data cleaning of SBCHavingDiabetesCoinsurance (The dollar amount of the coinsurance for the sample SBC scenario of having diabetes)
#Coinsurance = Eine Mitversicherung ist die Beteiligung mehrerer Versicherungsunternehmen an der Versicherung desselben Risikos
#SBC= Summary of Benefits and Coverage Provides Clear and Consistent Information == allowing employers and employees to make apples-to-apples comparisons among plans, understand what is covered and what it costs
head(pa$SBCHavingDiabetesCoinsurance, 100)

# replace all "," with " " AND all "\\$" with " " in SBCHavingDiabetesCoinsurance
pa$SBCHavingDiabetesCoinsurance<- gsub('\\$', '', pa$SBCHavingDiabetesCoinsurance)
pa$SBCHavingDiabetesCoinsurance<- gsub(',', '', pa$SBCHavingDiabetesCoinsurance)
# assign (and convert to numeric) the column of SBCHavingDiabetesCoinsurance
pa$coinsurance <- as.numeric(pa$SBCHavingDiabetesCoinsurance)
# fill the blank cells with 0
pa$coinsurance[is.na(pa$coinsurance)] <- 0
head(pa$coinsurance, 100)

#subset and filter all coinsurances which equals 0 (remove all 0 values)
pa <- subset(pa, coinsurance != 0)


##set data of coinsurance in a table for the barplot 
counts <- table(pa$coinsurance)

```


```{r, echo=FALSE}

#barplot of coinsurance
barplot(counts, main="Deckungskosten der Mitversicherung für Diabeteserkrankte in 2014",
        xlab="Dollar Amount", ylab="Counts", col="green")

# plot histogram of coinsurance dollar amount (x axis) and count in (y axis)
ggplot(pa, aes(x = pa$coinsurance)) + geom_histogram(col="black", fill="green")

```


## Die Liste der StateCodes und Durchschnittsdeckungskosten 
```{r,include=FALSE, echo=FALSE}
#list aggregation of the mean of the coinsurance with the statecode and print it 
df <- aggregate(pa$coinsurance, list(pa$StateCode), mean)
names(df) <- c("state", "coinsurance")



```

```{r, echo=FALSE}
#Set the title of the printed aggregated list above with new labels and print it 
df



```

